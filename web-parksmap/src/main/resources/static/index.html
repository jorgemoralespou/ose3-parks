<!doctype html>
<html lang="en">
<head>
	<title>Map Visualizer on OpenShift 3</title>
	<link rel="stylesheet" href="leaflet/leaflet.css"/>
	<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="leaflet/markercluster/MarkerCluster.css"/>
	<link rel="stylesheet" href="leaflet/markercluster/MarkerCluster.Default.css"/>
	<link href="leaflet/easyButton/easy-button.css" rel="stylesheet"/>
	<script src="leaflet/leaflet.js"></script>
	<script src="leaflet/markercluster/leaflet.markercluster.js"></script>
	<script src="leaflet/easyButton/easy-button.js"></script>

	<script src="jquery-3.1.0.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

	<style type="text/css">
		body {
			padding: 0;
			margin: 0;
		}

		html, body, #map {
			height: 100%;
			font-family: 'Oswald';
		}

		.leaflet-container .leaflet-control-zoom {
			margin-left: 13px;
			margin-top: 70px;
		}

		#map {
			z-index: 1;
		}

		#title {
			z-index: 2;
			position: absolute;
			left: 10px;
		}
	</style>
</head>

<body>
<h1 id="title" class="title">Map Visualizer on OpenShift 3</h1>
<div id="map"></div>

<script>
	//    var mlbpark = { name: "parks", displayName:"MLB Parks", url: "http://localhost:8081", visible: true, layer: new L.markerClusterGroup() };
	//    var nationalpark = { name: "nationalparks", displayName:"National Parks", url: "http://localhost:8082", visible: true, layer: new L.markerClusterGroup()  };

	var backends = [];


	var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';


	var grayscale = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
			streets = L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr});

	var map = L.map('map', {
		center: [39.82, -98.57],
		zoom: 5,
		layers: [grayscale]
	});

	var baseLayers = {
		"Grayscale": grayscale,
		"Streets": streets
	};

	var overlays = {};

	var controls = L.control.layers(baseLayers, overlays, {collapsed:false} );
	controls.addTo(map);

	function addBackend(backend){
		console.log("Adding layer for backend: " + backend.name);
		map.addLayer(backend.layer);
		controls.addOverlay(backend.layer, backend.displayName);

		$.get(backend.url + "/ws/data/", function(data){
			for (var i = 0; i < data.length; i++){
				dataPoint = data[i];
				var popupInformation = "<b>" + dataPoint.name + "</b></br>";
				var marker = L.marker([dataPoint.latitude, dataPoint.longitude]).bindPopup(popupInformation);
				// console.log("Data: " + dataPoint.name + " ("+ dataPoint.latitude + "," + dataPoint.longitude + ")=" + popupInformation);
				marker.addTo(backend.layer);
			}
		}, "json");
	}

	function removeBackend(backendName){
		var backend = getByAttr(backends, "name", backendName);
		controls.removeLayer(backend.layer);
		map.removeLayer(backend.layer);

		backends = removeByAttr(backends, 'name', backend.name);
	}

	function forEachBackend(){
		backends.forEach(function(backend){
			addBackend(backend);
		});
	}

	function initialLoad(){
		backends.length = 0;
		$.get("/ws/backends/", function(data){
			for (var i = 0; i < data.length; i++){
				var backendFromServer = data[i];
				var backend = {
					name: backendFromServer.name,
					displayName: backendFromServer.displayName,
					url: backendFromServer.url,
					visible: true,
					layer: new L.markerClusterGroup()
				};
				console.log("Backend: " + backend);
				backends.push(backend);
			}
			forEachBackend();
		}, "json");
	}

	// Set a timeout to load/unload backends
	setTimeout(function(){
		// Get notified of registrations/unregistrations

	}, 5000);

	map.whenReady(initialLoad);

	var removeByAttr = function(arr, attr, value){
		var i = arr.length;
		while(i--){
			if( arr[i]
					&& arr[i].hasOwnProperty(attr)
					&& (arguments.length > 2 && arr[i][attr] === value ) ){
				console.log("Removed: [" + i + "]" + arr[i] );
				arr.splice(i,1);

			}
		}
		return arr;
	}

	var getByAttr = function(arr, attr, value){
		var i = arr.length;
		while(i){
			if( arr[i]
					&& arr[i].hasOwnProperty(attr)
					&& (arguments.length > 2 && arr[i][attr] === value ) ){
				break;
			}
			i--;
		}
		console.log("getByAttr ("+value+"): [" + i + "]" + arr[i] );
		return arr[i];
	}

	// This toggles below are for testing services come and go manually, until the server works

	var mlbToggle = L.easyButton({
		states: [
			{
				stateName: 'add-mlb-markers',
				icon: '<span class="star">&check; MLBParks</span>',
				title: 'add MLB markers',
				onClick: function (control) {
					var b = { name: "mlbparks", displayName:"MLB Parks", url: "http://localhost:8081", visible: true, layer: new L.markerClusterGroup() };
					backends.push(b);
					addBackend(b);
					control.state('remove-mlb-markers');
				}
			}, {
				stateName: 'remove-mlb-markers',
				icon: '<span class="star">&cross; MLB Parks</span>',
				title: 'remove MLB markers',
				onClick: function (control) {
					removeBackend('mlbparks');
					control.state('add-mlb-markers');
				}
			}]
	});
	mlbToggle.state('remove-mlb-markers');
	mlbToggle.addTo(map);

	var natToggle = L.easyButton({
		states: [
			{
				stateName: 'add-nat-markers',
				icon: '<span class="star">&check; Nat Parks</span>',
				title: 'add Nat Parks markers',
				onClick: function (control) {
					var b = { name: "nationalparks", displayName:"National Parks", url: "", visible: true, layer: new L.markerClusterGroup() };
					backends.push(b);
					addBackend(b);
					control.state('remove-nat-markers');
				}
			}, {
				stateName: 'remove-nat-markers',
				icon: '<span class="star">&cross; MLB</span>',
				title: 'remove Nat Parks markers',
				onClick: function (control) {
					removeBackend('nationalparks');
					control.state('add-nat-markers');
				}
			}]
	});
	natToggle.state('remove-nat-markers');
	natToggle.addTo(map);
</script>
</body>
</html>
